# CardsHub - Cloudflare Workers Configuration (OpenNext)
name = "cardshub"
main = ".open-next/worker.js"
compatibility_date = "2024-12-01"
compatibility_flags = ["nodejs_compat"]

# Observability - enable logs
[observability]
enabled = true

[observability.logs]
enabled = true
head_sampling_rate = 1
invocation_logs = true

# Static assets
[assets]
directory = ".open-next/assets"
binding = "ASSETS"

# D1 Database binding
[[d1_databases]]
binding = "DB"
database_name = "cardshub-db"
database_id = "b81d49dc-a3e8-4be2-9fbe-835e4046deaf"

# R2 Bucket binding
[[r2_buckets]]
binding = "R2"
bucket_name = "cardshub-uploads"
# NOTE: Configure R2 lifecycle rule in dashboard to delete `uploads/pending/*` after 24h
# This cleans up orphaned presigned uploads that were never confirmed

# KV Cache binding
[[kv_namespaces]]
binding = "CACHE_KV"
id = "03473e806595491da3811b6820425aff"

# Images binding for transformations
[images]
binding = "IMAGES"

# Durable Objects for async processing
[[durable_objects.bindings]]
name = "IMAGE_PROCESSOR"
class_name = "ImageProcessor"
script_name = "cardshub"

[[migrations]]
tag = "v1"
new_classes = ["ImageProcessor"]

# Environment variables (set via dashboard or wrangler secret)
# DISCORD_CLIENT_ID
# DISCORD_CLIENT_SECRET

[vars]
NEXT_PUBLIC_APP_URL = "https://hub.axailotl.ai"
DISCORD_CLIENT_ID = "1446350528568229890"
# Secrets set via wrangler secret:
# DISCORD_CLIENT_SECRET
# R2_ACCESS_KEY_ID - R2 API token access key for presigned URLs
# R2_SECRET_ACCESS_KEY - R2 API token secret key for presigned URLs
# CLOUDFLARE_ACCOUNT_ID - Account ID for R2 S3 endpoint

# Development overrides
[env.development.vars]
NEXT_PUBLIC_APP_URL = "http://localhost:3000"

# Dev environment (for dev branch - testing before production)
[env.dev]
name = "cardshub-dev"

[[env.dev.d1_databases]]
binding = "DB"
database_name = "cardshub-db-dev"
database_id = "51735f7f-e7eb-43ed-8e4c-663d18ae529b"

[[env.dev.r2_buckets]]
binding = "R2"
bucket_name = "cardshub-uploads-dev"

[[env.dev.kv_namespaces]]
binding = "CACHE_KV"
id = "996ed4fd34f54915a8626b0a0589babd"

[env.dev.images]
binding = "IMAGES"

[[env.dev.durable_objects.bindings]]
name = "IMAGE_PROCESSOR"
class_name = "ImageProcessor"
script_name = "cardshub-dev"

[env.dev.vars]
NEXT_PUBLIC_APP_URL = "https://dev.hub.axailotl.ai"
DISCORD_CLIENT_ID = "1446350528568229890"

# Preview environment (for preview deployments)
[env.preview]
[[env.preview.d1_databases]]
binding = "DB"
database_name = "cardshub-db"
database_id = "b81d49dc-a3e8-4be2-9fbe-835e4046deaf"

[[env.preview.r2_buckets]]
binding = "R2"
bucket_name = "cardshub-uploads-preview"
